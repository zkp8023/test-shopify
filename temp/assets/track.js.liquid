class Tracker {
  constructor(options = {}) {
    this.TRacerData = {
      userId: null,
      website: window.location.hostname,
      page_url: window.location.href,
      page_title: document.title,
      device_type: this.getDeviceType(),
      client_os: navigator.userAgentData.platform,
      create_time: new Date().toLocaleString(),
      element_name: null,
      // element_id: null,
      burying_point_id: null,
      remark: null,
      ...options,
    }
  }

  getDeviceType() {
    const userAgent = navigator.userAgent
    if (/Mobi|Android|iPhone/i.test(userAgent))
      return 'Mobile'
    if (/Tablet|iPad/i.test(userAgent))
      return 'Tablet'
    return 'PC'
  }

  async emit() {
   await fetch('https://api.hi-pev.com/shopify-seo/api/save/point', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(this.TRacerData),
    })
      .then((response) => {
        if (!response.ok)
          throw new Error('è¯·æ±‚å¤±è´¥')
        return response.json()
      })
      .then(data => console.log('å‘é€æˆåŠŸ:', data))
      .catch(error => console.error('å‘é€å¤±è´¥:', error))
  }
}
// ç‚¹å‡»æŒ‰é’®
class TrackerClick extends Tracker {
  constructor() {
    super({
      event_type: 'click',
      event_name: 'ç‚¹å‡»',
    })
  }

  trackElementClicks(elementIds) {
    if (!Array.isArray(elementIds)) {
      console.error('å‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ˆå…ƒç´ IDåˆ—è¡¨ï¼‰')
      return
    }
    for (const element_id of elementIds) {
      const element = document.querySelector(element_id)
      if (!element) {
        console.warn(`æœªæ‰¾åˆ°IDä¸º ${element_id} çš„å…ƒç´ `)
        continue
      }
      // ç»‘å®šç‚¹å‡»äº‹ä»¶
      this.TRacerData.element_name = element.dataset.name || element.tagName.toLowerCase()
      this.TRacerData.burying_point_id = element.dataset.point_id
      element.addEventListener('click', () => {
        super.emit()
      })
    }
  }
}

// è®¿é—®é¡µé¢
class TracerPage extends Tracker {
  #enterTime = JSON.parse(sessionStorage.getItem('enterTime')) || null
  // è¿›å…¥é¡µé¢ç±»å‹, view:æµè§ˆ, enter:åˆšè¿›å…¥
  #viewType = 'view'
  constructor() {
    super({
      event_type: 'view-in',
      event_name: 'æµè§ˆ-è¿›',
    })
  }

  async trackPage(pageOption) {
    const { page, url, title } = pageOption
    // console.log(`å…±åœç•™:${totalTime}ç§’`)
    const burying_point_id = page === 'index' ? 10007 : 10011
    this.TRacerData.burying_point_id = burying_point_id
    // è¿›å…¥é¡µé¢
    if (this.#viewType === 'enter') {
      this.TRacerData.page_url = window.location.href
      this.TRacerData.page_title = document.title
      this.TRacerData.event_name = 'æµè§ˆ-è¿›'
      this.TRacerData.event_type = 'view-in'
      this.TRacerData.remark = null
    }
    // æµè§ˆé¡µé¢
    else {
      const totalTime = Math.abs((+new Date() - this.#enterTime) / 1000)
      this.TRacerData.page_url = url
      this.TRacerData.page_title = title
      this.TRacerData.event_name = 'æµè§ˆ-å‡º'
      this.TRacerData.event_type = 'view-out'
      this.TRacerData.remark = totalTime
    }
    super.emit().finally(() => {
      this.#viewType = null
    })
  }

  // æ˜¯å¦ç¬¦åˆé¡µé¢è·¯å¾„
  matchCondition(path) {
    return path === 'index' || path === 'product'
  }

  async trackPageVisit(pagePath) {
    // ä¿å­˜çš„ä¸Šä¸€é¡µ
    const prePage = JSON.parse(sessionStorage.getItem('prePage')) || {}
    console.log('ğŸš€  prePage', prePage)
    console.log('ğŸš€  pagePath', pagePath)

    // è¿›å…¥é¦–é¡µå’Œè¯¦æƒ…é¡µ
    if (this.matchCondition(pagePath)) {
      this.#viewType = 'enter'
      await this.trackPage({ page: pagePath })

      // åˆ·æ–°é¡µé¢
      if (pagePath === prePage.page) {
        return
      }

      // é¦–é¡µå’Œè¯¦æƒ…é¡µä¹‹é—´è·³è½¬
      if (this.matchCondition(prePage.page)) {
        this.#viewType = 'view'
        await this.trackPage(prePage)
      }

      this.#enterTime = JSON.parse(sessionStorage.getItem('enterTime')) || this.#enterTime
      sessionStorage.setItem('enterTime', +new Date())
      sessionStorage.setItem('prePage', JSON.stringify({
        page: pagePath,
        title: document.title,
        url: window.location.href,
      }))
    }
    // è¿›å…¥å…¶ä»–é¡µé¢
    else {
      // æ˜¯ä»é¦–é¡µå’Œè¯¦æƒ…é¡µè¿›å…¥çš„å…¶ä»–é¡µé¢,
      if (prePage) {
        this.#viewType = 'view'
        await this.trackPage(prePage)
        // æ¸…ç©ºè®°å½•çš„é¡µé¢ä¿¡æ¯
        sessionStorage.setItem('prePage', null)
        // æ¸…ç©ºè¿›å…¥æ—¶é—´
        sessionStorage.setItem('enterTime', null)
        this.#enterTime = null
      }
    }
  }
}
